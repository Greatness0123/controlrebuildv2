name: Build Electron App

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release'
        required: false
        default: '1.0.0'

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Download Python artifacts
      uses: .github/work use actions/download-artifact@v4
      with:
        name: python-${{ matrix.os == 'ubuntu-latest' && 'linux' || matrix.os == 'windows-latest' && 'windows' || 'macos' }}
        path: python-artifacts
    
    - name: Install dependencies
      run: npm ci
    
    - name: Prepare Python executables for ${{ matrix.os }}
      run: |
        mkdir -p assets/binaries
        if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          cp python-artifacts/dist/backend_modified assets/binaries/
          cp python-artifacts/AppImage/wakeword_helper.AppImage assets/binaries/
          chmod +x assets/binaries/*
        elif [ "${{ matrix.os }}" = "windows-latest" ]; then
          cp python-artifacts/dist/backend_modified.exe assets/binaries/
          cp python-artifacts/assets/wakeword/dist/wakeword_helper.exe assets/binaries/
        elif [ "${{ matrix.os }}" = "macos-latest" ]; then
          # Mount and extract DMGs
          hdiutil attach python-artifacts/backend_modified.dmg
          cp -r "/Volumes/Backend Modified/backend_modified.app" assets/binaries/
          hdiutil attach python-artifacts/wakeword_helper.dmg  
          cp "/Volumes/Wakeword Helper/wakeword_helper" assets/binaries/
          hdiutil detach "/Volumes/Backend Modified"
          hdiutil detach "/Volumes/Wakeword Helper"
          chmod +x assets/binaries/*
        fi
    
    - name: Build for ${{ matrix.os }}
      run: npm run build
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Package artifacts
      run: |
        mkdir -p dist-packaged
        if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          tar -czf dist-packaged/Control-linux-x64.tar.gz -C dist .
        elif [ "${{ matrix.os }}" = "windows-latest" ]; then
          cd dist
          7z a -tzip ../dist-packaged/Control-win-x64.zip *
          cd ..
        elif [ "${{ matrix.os }}" = "macos-latest" ]; then
          tar -czf dist-packaged/Control-mac-x64.tar.gz -C dist .
        fi
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: Control-${{ matrix.os }}
        path: dist-packaged/*

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v3
      with:
        path: release-artifacts
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release-artifacts/Control-ubuntu-latest/*
          release-artifacts/Control-windows-latest/*
          release-artifacts/Control-macos-latest/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        # lets see if this works