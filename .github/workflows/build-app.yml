name: Build Electron App

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release'
        required: false
        default: '1.0.0'

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'
        cache: 'npm'
    
    - name: Download Python artifacts
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        # maps matrix.os to python-linux / python-windows / python-macos
        name: python-${{ matrix.os == 'ubuntu-latest' && 'linux' || matrix.os == 'windows-latest' && 'windows' || 'macos' }}
        path: python-artifacts

    - name: Install dependencies
      run: npm ci
    
    - name: Prepare Python executables for ${{ matrix.os }}
      # force bash so the same POSIX script runs on windows/mac/linux
      shell: bash
      run: |
        echo "Checking for python-artifacts in: $(pwd)/python-artifacts"
        mkdir -p assets/binaries

        if [ ! -d "python-artifacts" ] || [ -z "$(ls -A python-artifacts 2>/dev/null)" ]; then
          echo "WARNING: python-artifacts directory is missing or empty."
          echo "If you expect python artifacts to be downloaded, make sure they were uploaded using actions/upload-artifact with the name:"
          echo "  python-${{ matrix.os == 'ubuntu-latest' && 'linux' || matrix.os == 'windows-latest' && 'windows' || 'macos' }}"
          echo ""
          echo "Proceeding without python binaries. If these are required for your build, this will likely fail later."
        else
          if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            [ -f python-artifacts/dist/backend_modified ] && cp python-artifacts/dist/backend_modified assets/binaries/ || echo "backend_modified not found for linux"
            [ -f python-artifacts/AppImage/wakeword_helper.AppImage ] && cp python-artifacts/AppImage/wakeword_helper.AppImage assets/binaries/ || echo "wakeword_helper.AppImage not found for linux"
            chmod +x assets/binaries/* || true
          elif [ "${{ matrix.os }}" = "windows-latest" ]; then
            # on windows runner bash is available; executables typically have .exe
            [ -f python-artifacts/dist/backend_modified.exe ] && cp python-artifacts/dist/backend_modified.exe assets/binaries/ || echo "backend_modified.exe not found for windows"
            [ -f python-artifacts/assets/wakeword/dist/wakeword_helper.exe ] && cp python-artifacts/assets/wakeword/dist/wakeword_helper.exe assets/binaries/ || echo "wakeword_helper.exe not found for windows"
          elif [ "${{ matrix.os }}" = "macos-latest" ]; then
            # Ensure expected DMG files exist before attempting to attach
            if [ -f python-artifacts/backend_modified.dmg ]; then
              hdiutil attach python-artifacts/backend_modified.dmg
              cp -r "/Volumes/Backend Modified/backend_modified.app" assets/binaries/ || echo "backend_modified.app not found in DMG"
              hdiutil detach "/Volumes/Backend Modified" || true
            else
              echo "backend_modified.dmg not found for macos"
            fi

            if [ -f python-artifacts/wakeword_helper.dmg ]; then
              hdiutil attach python-artifacts/wakeword_helper.dmg
              cp "/Volumes/Wakeword Helper/wakeword_helper" assets/binaries/ || echo "wakeword_helper not found in DMG"
              hdiutil detach "/Volumes/Wakeword Helper" || true
            else
              echo "wakeword_helper.dmg not found for macos"
            fi

            chmod +x assets/binaries/* || true
          fi
        fi
    
    - name: Build for ${{ matrix.os }}
      run: npm run build
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Package artifacts
      run: |
        mkdir -p dist-packaged
        if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          tar -czf dist-packaged/Control-linux-x64.tar.gz -C dist .
        elif [ "${{ matrix.os }}" = "windows-latest" ]; then
          cd dist
          7z a -tzip ../dist-packaged/Control-win-x64.zip *
          cd ..
        elif [ "${{ matrix.os }}" = "macos-latest" ]; then
          tar -czf dist-packaged/Control-mac-x64.tar.gz -C dist .
        fi

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Control-${{ matrix.os }}
        path: dist-packaged/*

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: release-artifacts
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release-artifacts/Control-ubuntu-latest/*
          release-artifacts/Control-windows-latest/*
          release-artifacts/Control-macos-latest/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}