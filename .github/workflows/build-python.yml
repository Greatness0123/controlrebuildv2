name: Build Python Components

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend_modified.py'
      - 'assets/wakeword/wakeword_helper.py'
      - 'vosk-server.py'
      - 'vosk-streaming-server.py'
      - 'requirements.txt'
  pull_request:
    branches: [ main ]
    paths:
      - 'backend_modified.py'
      - 'assets/wakeword/wakeword_helper.py'
      - 'vosk-server.py'
      - 'vosk-streaming-server.py'
      - 'requirements.txt'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build backend_modified.exe
      run: |
        pyinstaller --onefile --windowed --name backend_modified backend_modified.py
    
    - name: Build wakeword_helper.exe
      run: |
        cd assets/wakeword
        pyinstaller --onefile --console --name wakeword_helper wakeword_helper.py
    
    - name: Build vosk-server.exe
      run: |
        pyinstaller --onefile --console --name vosk-server vosk-server.py
    
    - name: Build vosk-streaming-server.exe
      run: |
        pyinstaller --onefile --console --name vosk-streaming-server vosk-streaming-server.py
    
    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: python-windows
        path: |
          dist/backend_modified.exe
          assets/wakeword/dist/wakeword_helper.exe
          dist/vosk-server.exe
          dist/vosk-streaming-server.exe

  build-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build backend_modified.dmg
      run: |
        pyinstaller --onefile --windowed --name backend_modified --icon=assets/icons/icon.icns backend_modified.py
    
    - name: Build wakeword_helper.dmg
      run: |
        cd assets/wakeword
        pyinstaller --onefile --console --name wakeword_helper wakeword_helper.py
    
    - name: Build vosk-server
      run: |
        pyinstaller --onefile --console --name vosk-server vosk-server.py
    
    - name: Build vosk-streaming-server
      run: |
        pyinstaller --onefile --console --name vosk-streaming-server vosk-streaming-server.py
    
    - name: Create DMG packages
      run: |
        # Create temporary directories
        mkdir -p temp/backend temp/wakeword temp/vosk
        # Copy executables
        cp dist/backend_modified.app temp/backend/
        cp assets/wakeword/dist/wakeword_helper temp/wakeword/
        cp dist/vosk-server temp/vosk/
        cp dist/vosk-streaming-server temp/vosk/
        # Create DMGs
        hdiutil create -volname "Backend Modified" -srcfolder temp/backend -ov -format UDZO backend_modified.dmg
        hdiutil create -volname "Wakeword Helper" -srcfolder temp/wakeword -ov -format UDZO wakeword_helper.dmg
        hdiutil create -volname "Vosk Servers" -srcfolder temp/vosk -ov -format UDZO vosk-servers.dmg
    
    - name: Upload macOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: python-macos
        path: |
          backend_modified.dmg
          wakeword_helper.dmg
          vosk-servers.dmg

  build-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-tk python3-dev portaudio19-dev
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build backend_modified.AppImage
      run: |
        pyinstaller --onefile --windowed --name backend_modified backend_modified.py
    
    - name: Build wakeword_helper.AppImage
      run: |
        cd assets/wakeword
        pyinstaller --onefile --console --name wakeword_helper wakeword_helper.py
        cd ../..
        # Create AppImage wrapper
        mkdir -p AppImage/wakeword
        cp assets/wakeword/dist/wakeword_helper AppImage/wakeword/
        cat > AppImage/wakeword_helper.AppImage << 'EOF'
        #!/bin/bash
        HERE="$(dirname "$(readlink -f "${0}")")"
        export LD_LIBRARY_PATH="${HERE}/lib:${LD_LIBRARY_PATH}"
        exec "${HERE}/wakeword/wakeword_helper" "$@"
        EOF
        chmod +x AppImage/wakeword_helper.AppImage
    
    - name: Build vosk-server
      run: |
        pyinstaller --onefile --console --name vosk-server vosk-server.py
    
    - name: Build vosk-streaming-server
      run: |
        pyinstaller --onefile --console --name vosk-streaming-server vosk-streaming-server.py
    
    - name: Create Vosk AppImage wrappers
      run: |
        mkdir -p AppImage/vosk
        cp dist/vosk-server AppImage/vosk/
        cp dist/vosk-streaming-server AppImage/vosk/
        cat > AppImage/vosk-server.AppImage << 'EOF'
        #!/bin/bash
        HERE="$(dirname "$(readlink -f "${0}")")"
        export LD_LIBRARY_PATH="${HERE}/lib:${LD_LIBRARY_PATH}"
        exec "${HERE}/vosk/vosk-server" "$@"
        EOF
        cat > AppImage/vosk-streaming-server.AppImage << 'EOF'
        #!/bin/bash
        HERE="$(dirname "$(readlink -f "${0}")")"
        export LD_LIBRARY_PATH="${HERE}/lib:${LD_LIBRARY_PATH}"
        exec "${HERE}/vosk/vosk-streaming-server" "$@"
        EOF
        chmod +x AppImage/*.AppImage
    
    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: python-linux
        path: |
          dist/backend_modified
          dist/vosk-server
          dist/vosk-streaming-server
          AppImage/wakeword_helper.AppImage
          AppImage/vosk-server.AppImage
          AppImage/vosk-streaming-server.AppImage